// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MODEL
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hashed with bcryptjs
  firstName String?
  lastName  String?

  // Financial preferences
  monthlyIncome          Decimal?      @db.Decimal(10, 2)
  targetDebtFreeDate     DateTime?
  preferredPayoffMethod  PayoffMethod  @default(AVALANCHE)
  currency               String        @default("USD")
  timeZone               String        @default("America/New_York")

  // Notification preferences (JSON for flexibility)
  notificationPreferences Json?

  // Optional asset tracking
  totalAssets            Decimal?      @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  creditCards CreditCard[]
  loans       Loan[]
  mortgages   Mortgage[]
  bills       Bill[]
  goals       Goal[]
  snapshots   Snapshot[]
  plaidItems  PlaidItem[]
  debtOrders  DebtOrder[]

  @@map("users")
  @@index([email])
}

enum PayoffMethod {
  AVALANCHE  // Highest interest rate first (saves most money)
  SNOWBALL   // Smallest balance first (psychological wins)
  CUSTOM     // User-defined order
}

// ============================================
// CREDIT CARD MODEL
// ============================================

model CreditCard {
  id             String   @id @default(cuid())
  userId         String
  name           String   // Card name/nickname

  // Financial details
  balance        Decimal  @db.Decimal(10, 2)
  creditLimit    Decimal  @db.Decimal(10, 2)
  interestRate   Decimal  @db.Decimal(5, 2) // APR percentage
  minimumPayment Decimal  @db.Decimal(10, 2)
  extraPayment   Decimal  @default(0) @db.Decimal(10, 2)

  // Payment details
  dueDay         Int?     // Day of month (1-31)
  autoPay        Boolean  @default(false)

  // Status
  status         CreditCardStatus @default(ACTIVE)

  // Plaid integration (optional)
  plaidAccountId String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plaidAccount   PlaidAccount? @relation(fields: [plaidAccountId], references: [id])

  @@map("credit_cards")
  @@index([userId])
  @@index([status])
  @@index([plaidAccountId])
}

enum CreditCardStatus {
  ACTIVE
  PAID_OFF
  CLOSED
}

// ============================================
// LOAN MODEL
// ============================================

model Loan {
  id             String   @id @default(cuid())
  userId         String
  name           String   // Loan name/nickname

  // Loan type
  loanType       LoanType

  // Financial details
  principal      Decimal  @db.Decimal(10, 2) // Original amount
  currentBalance Decimal  @db.Decimal(10, 2)
  interestRate   Decimal  @db.Decimal(5, 2) // APR percentage
  termMonths     Int      // Total term in months
  monthlyPayment Decimal  @db.Decimal(10, 2)
  extraPayment   Decimal  @default(0) @db.Decimal(10, 2)

  // Dates
  startDate      DateTime

  // Plaid integration (optional)
  plaidAccountId String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plaidAccount   PlaidAccount? @relation(fields: [plaidAccountId], references: [id])

  @@map("loans")
  @@index([userId])
  @@index([loanType])
  @@index([plaidAccountId])
}

enum LoanType {
  PERSONAL
  AUTO
  STUDENT
  OTHER
}

// ============================================
// MORTGAGE MODEL
// ============================================

model Mortgage {
  id                  String   @id @default(cuid())
  userId              String
  name                String   // Property name/nickname

  // Property details
  propertyAddress     String?

  // Financial details
  loanAmount          Decimal  @db.Decimal(12, 2) // Original loan amount
  currentBalance      Decimal  @db.Decimal(12, 2)
  interestRate        Decimal  @db.Decimal(5, 2) // APR percentage
  termYears           Int      // Total term in years
  monthlyPayment      Decimal  @db.Decimal(10, 2) // P&I only
  extraPayment        Decimal  @default(0) @db.Decimal(10, 2)

  // Additional costs
  propertyTax         Decimal? @db.Decimal(10, 2) // Annual
  homeownersInsurance Decimal? @db.Decimal(10, 2) // Annual
  pmi                 Decimal? @db.Decimal(10, 2) // Monthly

  // Dates
  startDate           DateTime

  // Plaid integration (optional)
  plaidAccountId      String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plaidAccount        PlaidAccount? @relation(fields: [plaidAccountId], references: [id])

  @@map("mortgages")
  @@index([userId])
  @@index([plaidAccountId])
}

// ============================================
// BILL MODEL
// ============================================

model Bill {
  id          String        @id @default(cuid())
  userId      String
  name        String        // Bill name

  // Bill details
  category    BillCategory
  amount      Decimal       @db.Decimal(10, 2)
  frequency   BillFrequency @default(MONTHLY)

  // Payment details
  dueDay      Int?          // Day of month (1-31)
  autoPay     Boolean       @default(false)
  isEssential Boolean       @default(true)

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("bills")
  @@index([userId])
  @@index([category])
  @@index([frequency])
}

enum BillCategory {
  HOUSING
  TRANSPORTATION
  UTILITIES
  FOOD
  HEALTHCARE
  INSURANCE
  ENTERTAINMENT
  SUBSCRIPTIONS
  OTHER
}

enum BillFrequency {
  WEEKLY
  BI_WEEKLY
  MONTHLY
  QUARTERLY
  ANNUALLY
}

// ============================================
// GOAL MODEL
// ============================================

model Goal {
  id                  String       @id @default(cuid())
  userId              String
  name                String       // Goal name

  // Goal details
  goalType            GoalType
  targetAmount        Decimal      @db.Decimal(10, 2)
  currentAmount       Decimal      @default(0) @db.Decimal(10, 2)
  monthlyContribution Decimal?     @db.Decimal(10, 2)

  // Target
  targetDate          DateTime?
  priority            GoalPriority @default(MEDIUM)

  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  // Relations
  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("goals")
  @@index([userId])
  @@index([goalType])
  @@index([priority])
}

enum GoalType {
  SAVINGS
  EMERGENCY_FUND
  DEBT_PAYOFF
  INVESTMENT
  PURCHASE
  OTHER
}

enum GoalPriority {
  LOW
  MEDIUM
  HIGH
}

// ============================================
// SNAPSHOT MODEL
// ============================================

model Snapshot {
  id                     String   @id @default(cuid())
  userId                 String
  name                   String   // Snapshot name (e.g., "January 2025")

  // Snapshot date
  snapshotDate           DateTime

  // Debt totals
  totalDebt              Decimal  @db.Decimal(12, 2)
  totalCreditCardDebt    Decimal  @default(0) @db.Decimal(12, 2)
  totalLoanDebt          Decimal  @default(0) @db.Decimal(12, 2)
  totalMortgageDebt      Decimal  @default(0) @db.Decimal(12, 2)

  // Payment totals
  totalMonthlyPayments   Decimal  @db.Decimal(10, 2)
  totalMonthlyBills      Decimal  @db.Decimal(10, 2)

  // Income and ratios
  monthlyIncome          Decimal? @db.Decimal(10, 2)
  debtToIncomeRatio      Decimal? @db.Decimal(5, 2) // Percentage
  creditUtilization      Decimal? @db.Decimal(5, 2) // Percentage

  // Asset tracking (optional)
  totalAssets            Decimal? @db.Decimal(12, 2)
  netWorth               Decimal? @db.Decimal(12, 2) // Assets - Debts

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Relations
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("snapshots")
  @@index([userId])
  @@index([snapshotDate])
}

// ============================================
// PLAID INTEGRATION MODELS
// ============================================

model PlaidItem {
  id            String   @id @default(cuid())
  userId        String

  // Plaid details
  accessToken   String   // Encrypted
  itemId        String   @unique
  institutionId String?
  institutionName String?

  // Status
  status        PlaidItemStatus @default(ACTIVE)

  // Sync tracking
  connectedAt   DateTime @default(now())
  lastSyncAt    DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  accounts      PlaidAccount[]

  @@map("plaid_items")
  @@index([userId])
  @@index([itemId])
  @@index([status])
}

enum PlaidItemStatus {
  ACTIVE
  DISCONNECTED
  ERROR
}

model PlaidAccount {
  id              String   @id @default(cuid())
  plaidItemId     String

  // Plaid account details
  accountId       String   @unique // Plaid account ID
  accountName     String
  officialName    String?
  accountType     String   // checking, savings, credit card, loan, mortgage
  accountSubtype  String?

  // Balance information
  currentBalance  Decimal? @db.Decimal(12, 2)
  availableBalance Decimal? @db.Decimal(12, 2)
  limit           Decimal? @db.Decimal(12, 2)

  // Mask (last 4 digits)
  mask            String?

  // Currency
  currency        String   @default("USD")

  // Last sync
  lastSyncAt      DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  plaidItem       PlaidItem      @relation(fields: [plaidItemId], references: [id], onDelete: Cascade)
  creditCards     CreditCard[]
  loans           Loan[]
  mortgages       Mortgage[]

  @@map("plaid_accounts")
  @@index([plaidItemId])
  @@index([accountId])
  @@index([accountType])
}

// ============================================
// DEBT ORDER MODEL (for custom payoff order)
// ============================================

model DebtOrder {
  id       String @id @default(cuid())
  userId   String
  debtId   String // ID of the debt (credit card, loan, or mortgage)
  debtType String // 'credit_card', 'loan', 'mortgage'
  priority Int    // 1 = pay off first, 2 = second, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, debtId, debtType])
  @@map("debt_orders")
  @@index([userId])
  @@index([priority])
}
